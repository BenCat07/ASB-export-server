# Export Server API

This API is designed to connect the [ASB Export Gun](https://www.curseforge.com/ark-survival-ascended/mods/ark-smart-breeding-export-gun) mod to [ASB](https://github.com/cadon/ARKStatsExtractor), allowing export files and server config
data to be sent directly from console to a running instance of ASB.

Privacy is accomplished via a token generated by ASB and entered manually into the mod on the console.

Currently defined endpoints:

| Method | Path                | Purpose |
|--------|---------------------|---------|
| GET | /api/v1/listen/[token] | A long-running connection for ASB to listen for events |
| PUT or POST | /api/v1/export/[token] | Used by the mod to send export files |
| PUT or POST | /api/v1/server/[token]/[hash] | Used by the mod to send server config files |

All endpoints are rate-limited.

## General
For the JSON endpoints, a valid JSON response will always be generated. This includes some fields to help the game mod identify its own response. See below the examples for more detail.

If no response is needed a simple success response will be returned:
```json
{
    "success": true,
    "responseId": <number>,
    "service": "asb-export-server",
    "endpoint": <string>
}
```

On error, JSON of the following form is returned:
```json
{
    "error": {
        "code": <code>,
        "message": "<message>",
    },
    "responseId": <number>,
    "service": "asb-export-server",
    "endpoint": <string>
}
```

In all cases the common fields are:

| Name | Type | Description |
|-|-|-|
|`responseId`|`number`| A copy of the `responseId` query parameter on the request, if present |
|`service`|`string`| Always the literal `"asb-export-server"` |
|`endpoint`|`string`| The endpoint that was called but without replaced parameters, for example: `/api/v1/export/[token]` |

## Endpoints

### Send Export file
```
PUT/POST /api/v1/export/[token]
```
Allows the client mod to send an export file. The token must have previously been given to the user by the receiver (usually ASB).

**Note:** that if a server file is required is should be sent ***before*** the export.

The request must include the following headers:
| Header | Value |
|-|-|
| `content-length` | Must be valid (strict size-limits apply) |

#### Errors
The following HTTP status codes can be generated:

| Status | Name | Meaning |
|-|-|-|
| `200` | OK | Export file is accepted |
| `400` | Bad Request | Invalid token, headers or data |
| `424` | Failed Dependency | No listener is connected with this token currently |
| `429` | Too Many Requests | Rate limiting has denied this request |
| `500+` | Server Error | Something went wrong with the server or its proxy |

#### Testing
Example using HTTPie:
```
http put <server>/api/v1/export/123456 < "...\DinoExports\ASB\Iguanodon_307252455-304387993.json"
```

### Send Server config file
```
PUT/POST /api/v1/server/[token]/[hash]
```
Allows the client mod to send a server configuration file. The token must have previously been given to the user by the receiver (usually ASB), and the hash is the same one included in the creature export file. The JSON file must be included as the body.

The request must include the following headers:
| Header | Value |
|-|-|
| `content-length` | Must be valid (strict size-limits apply) |

#### Errors
The following HTTP status codes can be generated:

| Status | Name | Meaning |
|-|-|-|
| `200` | OK | Export file is accepted |
| `400` | Bad Request | Invalid token, headers or data |
| `424` | Failed Dependency | No listener is connected with this token currently |
| `429` | Too Many Requests | Rate limiting has denied this request |
| `500+` | Server Error | Something went wrong with the server or its proxy |

#### Testing
Example using HTTPie:
```
http put <server>/api/v1/server/123456/-8953437 < "...\DinoExports\ASB\Servers\-895343795.json"
```

### Check For Listener
```
GET /api/v1/export/[token]
```
Allows the client mod to check a listener is active on the given token. HTTP status codes are used to indicate the result - in particular 200 and 424.

#### Responses
The following HTTP status codes can be generated:

| Status | Name | Meaning |
|-|-|-|
| `200` | OK | Token has a current listener |
| `400` | Bad Request | Invalid token, headers or data |
| `424` | Failed Dependency | No listener is connected with this token currently |
| `429` | Too Many Requests | Rate limiting has denied this request |
| `500+` | Server Error | Something went wrong with the server or its proxy |

#### Testing
Example using HTTPie:
```
$ http get <server>/api/v1/check/12345-abcde?responseId=abc123abc
HTTP/1.1 200 OK
Access-Control-Allow-Origin: *
Connection: keep-alive
Date: Sat, 27 Apr 2024 13:31:10 GMT
Keep-Alive: timeout=5
content-length: 104
content-type: application/json

{
    "endpoint": "/api/v1/check/[token]",
    "responseId": "abc123abc",
    "service": "asb-export-server",
    "success": true
}
```
### Listening
```
GET /api/v1/listen/[token]
```

Allows the receiver (usually ASB) to connect and receive events from the mod as they happen. It is intended that ASB generates the token and shows it to the user so they can enter it into the mod. It should be saved associated with the ASB instance, not per library (to avoid clashes when sharing a library).

This endpoint uses SSE ([Server-Sent Events](https://developer.mozilla.org/en-US/docs/Web/API/Server-sent_events/Using_server-sent_events)) to keep the channel open and stream events to the caller as they happen.

The receiver should automatically reconnect to this endpoint to ensure continued service. The exception to this rule is when the `replaced` event is received, which indicates another receiver has taken over for this token.

#### Errors
The following HTTP status codes can be generated:

| Status | Name | Meaning |
|-|-|-|
| `200` | OK | Connection is accepted |
| `400` | Bad Request | Invalid token, headers or data |
| `429` | Too Many Requests | Rate limiting has denied this request |
| `507` | Insufficient Storage | The server has too many listeners connected |
| `500+` | Server Error | Something went wrong with the server or its proxy |

#### Events
Each message is sent as one or more lines of the form `<name>: <value>` with a full blank line is used to denote the end of this message (i.e. `\n\n`). We use the form `event: <event name>` as the first line to inform the message type.

Possible event types:
| Form            | Meaning |
|-----------------|---------|
| `welcome`       | This connection is now active |
| `ping`          | Sent regularly to maintain the connection - can be ignored |
| `replaced`      | Another listener connected with this token |
| `export`        | A creature export file immediately follows as `data: <JSON encoded file>` |
| `server <hash>` | A server config file immediately follows as `data: <JSON encoded file>` |
| `closing`       | This connection is closing but reconnection is allowed (e.g. on a server restart) |

Where data is expected (for `export` and `server` events) it will be supplied on the next line encoded as JSON and includes as `data: <JSON encoded data>`.

#### Testing
To listen using `curl` is simple:
```
$ curl <server>/api/v1/listen/123456
event: welcome
```

#### Example Stream
Full transcript of an example stream:
```
event: welcome

event: ping

event: export
data: {"Format":1,"DinoName":"Generated","TribeName":"QuackTribe","SpeciesName":"Iguanodon","TamerString":"Quackers","OwningPlayerName":"","ImprinterName":"","OwningPlayerID":0,"DinoID1":"307252455","DinoID2":"304387993","BlueprintPath":"/Game/PrimalEarth/Dinos/Iguanodon/Iguanodon_Character_BP.Iguanodon_Character_BP_C","Stats":[{"Wild":1,"Tamed":0,"Mutated":0,"Value":300.07000732421875},{"Wild":1,"Tamed":0,"Mutated":0,"Value":220},{"Wild":7,"Tamed":0,"Mutated":0,"Value":298.70001220703125},{"Wild":1,"Tamed":0,"Mutated":0,"Value":165},{"Wild":1,"Tamed":0,"Mutated":0,"Value":1980},{"Wild":0,"Tamed":0,"Mutated":0,"Value":100},{"Wild":0,"Tamed":0,"Mutated":0,"Value":0},{"Wild":1,"Tamed":0,"Mutated":0,"Value":382.5},{"Wild":1,"Tamed":0,"Mutated":0,"Value":0.3171199560165405},{"Wild":1,"Tamed":0,"Mutated":0,"Value":0},{"Wild":0,"Tamed":0,"Mutated":0,"Value":0},{"Wild":0,"Tamed":0,"Mutated":0,"Value":0}],"ColorSetIndices":[82,0,0,0,26,30],"ColorSetValues":{"0":[0.0262410007417202,0.014444000087678432,0.027320999652147293,0],"1":[1,1,1,1],"2":[1,1,1,1],"3":[1,1,1,1],"4":[0.19499999284744263,0.30000001192092896,0.19499999284744263,0],"5":[0.7799999713897705,0.699999988079071,1,0]},"IsFemale":true,"NextAllowedMatingTimeDuration":0,"BabyAge":1,"MutagenApplied":false,"Neutered":false,"RandomMutationsMale":0,"RandomMutationsFemale":0,"ServerMultipliersHash":"-895343795","TameEffectiveness":1,"BaseCharacterLevel":8,"DinoImprintingQuality":0}

event: server 1234567
data: {"Version":2,"WildLevel":[1,1,1,1,1,1,1,1,1,1,1,1],"TameLevel":[0.20000000298023224,1,1,1,1,1,1,1,0.17000000178813934,1,1,1],"TameAdd":[0.14000000059604645,1,1,1,1,1,1,1,0.14000000059604645,1,1,1],"TameAff":[0.4399999976158142,1,1,1,1,1,1,1,0.4399999976158142,1,1,1],"WildLevelStepSize":4,"MaxWildLevel":120,"DestroyTamesOverLevelClamp":0,"TamingSpeedMultiplier":1,"DinoCharacterFoodDrainMultiplier":1,"MatingSpeedMultiplier":1,"MatingIntervalMultiplier":0.10000000149011612,"EggHatchSpeedMultiplier":10,"BabyMatureSpeedMultiplier":10,"BabyCuddleIntervalMultiplier":0.10000000149011612,"BabyImprintAmountMultiplier":1,"BabyImprintingStatScaleMultiplier":1,"BabyFoodConsumptionSpeedMultiplier":1,"TamedDinoCharacterFoodDrainMultiplier":1,"WildDinoTorporDrainMultiplier":1,"WildDinoCharacterFoodDrainMultiplier":1,"AllowSpeedLeveling":false,"AllowFlyerSpeedLeveling":false,"UseSingleplayerSettings":false,"SessionName":"The Carnotaurus Trials - (v26.38)"}

event: ping

event: ping

event: replaced
```
